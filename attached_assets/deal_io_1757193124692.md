# üö® Pivot: AI/ML‚ÄëFirst Build (Replit‚Äëfriendly)

**Why:** You hit first‚Äërun issues in Replit. We‚Äôre flipping the plan to be *AI/ML‚Äëfirst* while also making the project **boot reliably on Replit** with or without API keys.

**Key shifts**

- **Runtime:** React + Vite UI **plus** a tiny Node server (Express/Hono) for APIs. (If you already have Next, keep it‚Äîthese endpoints map 1:1.)
- **DB/ORM:** **Drizzle** (confirmed by repo) with **SQLite for dev** (always boots on Replit) and **Postgres optional** (toggle by env). No Prisma.
- **AI layer:** Provider‚Äëagnostic wrappers (OpenAI/Anthropic), feature‚Äëflagged; deterministic fallback when keys are absent.
- **RAG:** pgvector **or** in‚Äëprocess embeddings store (LiteVector) so it works without managed PG.
- **ML hooks:** outcome capture + feature view from day one; learning boost flag off by default.

---

# Replit V0.1 Build Plan ‚Äì Vendor Deal Optimization

**Goal (plain English):** Drag vendor deal files into a **Weekly Inbox**, click **Score All Deals**, and instantly get a ranked **Weekly Deal Bank** with plain‚Äëlanguage reasons and exportable CSV/TXT/JSON. The 65‚Äëitem ad set is optional and can be staged later.

---

## 1) Outcomes & Success Metrics

- **Time to Pick‚ÄëList (TTP):** ‚â§ 5 minutes from upload to exports.
- **Explainability:** Every scored item shows component chips (margin / velocity / funding / theme / timing / competitive) with values.
- **Department Mix:** Default targets: Meat 25‚Äì30%, Grocery 30‚Äì35%, Produce 20‚Äì25%, Bakery 15‚Äì20% (editable per batch).
- **Pricing Guardrails:** Margin floors by dept honored; multi‚Äëbuy patterns suggested.
- **Reliability:** End‚Äëto‚Äëend happy‚Äëpath demo works on fresh Repl with only `DATABASE_URL`.

---

## 2) Non‚ÄëNegotiables

- One **Replit** repo (Next.js App Router + Prisma + Postgres).
- **Week‚Äëcentric flow** (Wed‚ÜíTue label) with an explicit **Week schedule** (YYYY‚ÄëW##) and a ‚ÄúWeekly Inbox‚Äù for files.
- Persisted **Score** and **Recommendation**; exports read from these tables.
- No real secrets in repo; `.env.example` only.

---

## 3) Architecture Decisions (V0.1, AI/ML‚ÄëFirst)

- **UI:** React + Vite (or keep Next if already scaffolded). Minimal Tailwind. Keyboard shortcuts.
- **Server:** Node + Express/Hono under `server/` (can run as Next API routes if you‚Äôre on Next). All endpoints dual‚Äëmountable.
- **DB/ORM:** Drizzle. **Default: SQLite** file in `/data/app.db` (works offline). **Optional:** Postgres via `DB_URL`.
- **Scoring:** Deterministic rule engine (margin/velocity/funding/theme/timing/competitive) + plain‚Äëlanguage reasons. **ML boost off by default.**
- **AI:** Feature‚Äëflagged provider wrappers; endpoints for *AI Assist parsing* and *explanations*. Deterministic fallback if disabled.
- **RAG:** Embedding store for glossary/vendor terms; file‚Äëbacked store for dev, pgvector when Postgres is enabled.
- **Exports & Audit:** Export history, source refs, signed originals.

---

## 4) 7‚ÄëDay Build Plan (AI/ML‚ÄëFirst + Replit‚Äëproof)

**Day 1 ‚Äì Boot skeleton**

- Ensure Vite UI + Node server run concurrently. Add SQLite config; `db:push`, `db:seed`, `/health`.

**Day 2 ‚Äì Core models & ingest**

- Drizzle tables for AdWeek, SourceDoc, DealRow, Score; Weekly Inbox upload; originals saved; signed URL util.

**Day 3 ‚Äì Scoring & reasons**

- Rule engine + reasons; Deals table; Quality‚Äëgate; Stepper scaffolding.

**Day 4 ‚Äì Exports & audit**

- CSV/TXT/JSON with source refs; ExportHistory records.

**Day 5 ‚Äì AI layer (flags + endpoints)**

- Provider wrappers + `/api/ai/explain`, `/api/ai/extract`; AiCall/AiProposedRow tables; budget guard.

**Day 6 ‚Äì RAG & Glossary**

- Embed glossary/terms into local store (switchable to pgvector). Tooltip definitions; AI prompts include retrieved context.

**Day 7 ‚Äì Outcomes & ML hooks**

- Outcome table; featureView; `learningBoost` stub; flagged blend in scoring; docs + demo.

---

## 5) Data Contracts (TypeScript, AI/ML‚ÄëFirst)

```ts
// Core
interface AdWeek { id: string; year: number; week: number; label: string; start: string; end: string; status: 'Inbox'|'Parsing'|'Issues'|'Scored'|'Exported'; }
interface SourceDoc { id: string; adWeekId: string; kind: 'base-planner'|'dept-planner'|'group-buy-pdf'|'sales-plan-pptx'|'rolling-stock'|'other'; vendor?: string; filename: string; mimetype: string; byteSize: number; storagePath: string; hash: string; pageCount?: number; meta?: any; }
interface DealRow { id: string; adWeekId: string; sourceDocId: string; itemCode: string; description: string; dept: string; cost?: number; srp?: number; adSrp?: number; vendorFundingPct?: number; mvmt?: number; competitorPrice?: number; pack?: string; size?: string; promoStart?: string; promoEnd?: string; sourceRef?: { page?: number; yOffset?: number }; }

// Scoring
interface ScoreComponents { margin: number; velocity: number; funding: number; theme: number; timing: number; competitive: number; }
interface Multipliers { newItem: number; seasonal: number; strategic: number; historical: number; privateLabel?: number; }
interface Score { id: string; adWeekId: string; itemCode: string; total: number; components: ScoreComponents; multipliers: Multipliers; reasons: string[]; refinedReason?: string; }

// AI logging & proposals
interface AiCall { id: string; adWeekId?: string; sourceDocId?: string; kind: 'extract'|'map'|'explain'; provider: string; model: string; promptHash: string; tokensIn: number; tokensOut: number; costUsd: number; status: 'ok'|'error'|'budget_exceeded'; createdAt: string; }
interface AiProposedRow { id: string; adWeekId: string; sourceDocId: string; payload: any; confidence?: number; approved: boolean; approvedBy?: string; createdAt: string; }

// Outcomes (for ML)
interface Outcome { id: string; adWeekId: string; itemCode: string; units?: number; salesUsd?: number; realizedMarginPct?: number; createdAt: string; }

// Export audit
interface ExportHistory { id: string; adWeekId: string; createdBy: string; createdAt: string; artifactType: 'csv'|'txt'|'json'; artifactHash: string; meta?: any; }
```

---

## 6) File Intake Rules (V0.1)

- **Rolling Stock (XLSX):** headers `ITEM CD`, `DESCRIPTION`, `RETAIL DEPT`, `NET COST` ‚Üí code/desc/dept/cost.
- **Pending Promos (CSV):** `CODE`, `DESCRIPTION`, `DEPT`, `AMOUNT` ‚Üí promo list (ad price/funding if present).
- **Meat Planner (XLSX):** `ITEM NO`, `DESCRIPTION`, `AD SRP`, `UNIT COST` ‚Üí dept="Meat".
- **Grocery Planner (XLSX):** `ITEM DESC`, `AD_SRP`, `NET UNIT COST`, `GP%`, `MVMT` ‚Üí dept="Grocery".
- **Produce Planner (XLSX):** `Item #`, `Description`, `Ad SRP` ‚Üí dept="Produce".
- **Bakery/Deli (XLSX):** `Number`, `Item Description`, `Retail`, `Cost` ‚Üí dept="Bakery".
- Auto‚Äëdetect by filename patterns and header signatures; show per‚Äëfile status during ingest.

---

## 7) Scoring Spec (defaults)

**Weights:** margin .25, velocity .25, funding .20, theme .15, timing .10, competitive .05.

**Component scoring (0‚Äì100 examples):**

- Margin: ‚â•30% ‚Üí 100; ‚â•25% ‚Üí 85; ‚â•20% ‚Üí 70; ‚Ä¶ <10% ‚Üí 10.
- Velocity: expected lift ‚â•4√ó ‚Üí 100; ‚â•3√ó ‚Üí 85; ‚â•2.5√ó ‚Üí 70; ‚Ä¶
- Funding: ‚â•20% ‚Üí 100; ‚â•15% ‚Üí 85; ‚â•10% ‚Üí 70; 0% ‚Üí 0.
- Theme: primary keyword +40; secondary +20; bonus category +30; capped 100.
- Timing: start aligned to week ‚Üí 100; ‚â§3d ‚Üí 80; ‚â§7d ‚Üí 60; ‚â§14d ‚Üí 40; else 20.
- Competitive: ‚â•15% cheaper ‚Üí 100; ‚â•10% ‚Üí 80; ‚â•5% ‚Üí 60; worse ‚Üí 20.

**Multipliers:** newItem 1.0‚Äì1.3; seasonal 1.0‚Äì1.5; strategic 1.0‚Äì2.0; historical 0.7‚Äì1.2; privateLabel +1.4 optional.

**Interpretation:** ‚â•85 MUST INCLUDE; 70‚Äì84.9 STRONGLY RECOMMENDED; 55‚Äì69.9 RECOMMENDED; 40‚Äì54.9 CONSIDER; <40 SKIP.

---

## 8) Dept Mix & Guardrails

- Targets for 65 items: Meat \~19, Grocery \~19, Produce \~13, Bakery \~13 (adjust by sliders).
- Enforce **margin floors**: Meat 18%, Grocery 22%, Produce 25%, Bakery 30%.
- Pricing helper suggests patterns by cost bands (e.g., 5/\$5 for small items; 2/\$5 sweet spot; unit for high price).

---

## 9) Exports (contract)

**pick-list.csv**

```
Item Code,Product Name,Ad Price,Pricing Strategy,Department,Score
0001234,"COCA COLA 12PK",4.99,"2 for $9",Grocery,87.5
```

**buyer-report.txt** (grouped by dept with hero tags, stock alerts, action items). **designer.json** (fields for item, price copy, pattern, hero flag, dept, rank, notes).

---

## 10) Quality Gates & Errors

- Block scoring if >5% unresolved rows or missing cost/ad\_srp on >5% of candidates.
- Display blockers with counts and top 3 fixes (e.g., ‚ÄúAdd cost for 17 items in Grocery‚Äù).
- Soft warnings for competitor price missing (competitive score set to default baseline).

---

## 11) Test Scenarios (acceptance)

1. Upload mixed CSV/XLSX; app detects all and canonicalizes.
2. Run scoring; see chips and totals; adjust weights; re‚Äëscore changes order.
3. Lock 5 items; rerun selection; locked items remain; dept bars stay within ¬±2 items of target.
4. Download all three exports; verify counts and fields.
5. (Optional) Set theme keywords for a week; verify theme scores influence rank.

---

## 12) Risks & Mitigations

- **Excel header drift:** Maintain a header alias map; show ‚Äúunknown column‚Äù warnings with suggested mappings.
- **PDF/PPTX extraction noise (V0.2):** Use basic text extract + manual review UI; keep CSV/XLSX as truth.
- **Data gaps:** Provide importer to patch costs/margins at batch level.
- **Performance on large files:** Stream parsing; chunked inserts; DB indices on `(batchId, itemCode)`.

---

## 13) V0.2 Backlog (2‚Äì3 weeks)

- PDF & PPTX parsing; manual text selection to CSV.
- ProfitPilot signage PDF export integration.
- Outcome tracking: attach sales + margin results; simple model to adjust multipliers.
- Vendor scorecards; competitive scraping connector.

---

## 14) Replit: Boot‚ÄëProof Setup (AI/ML‚ÄëFirst)

### Secrets & Flags (add to Replit ‚Üí Tools ‚Üí Secrets)

```
# DB
DB_DIALECT=sqlite        # sqlite | postgres
DATABASE_URL=file:./data/app.db   # for sqlite
# or: postgres://user:pass@host:5432/dbname

# AI (optional)
AI_ENABLED=false
AI_PROVIDER=anthropic    # or openai
AI_MODEL=haiku-3.5       # or gpt-4o-mini
AI_WEEKLY_BUDGET_USD=5
OPENAI_API_KEY=
ANTHROPIC_API_KEY=

# Server
APP_SECRET=change-me     # used for signed URLs
```

### NPM scripts (ensure these exist)

```
"scripts": {
  "dev": "concurrently \"npm:dev:server\" \"npm:dev:client\"",
  "dev:client": "vite",
  "dev:server": "tsx server/index.ts",
  "db:push": "drizzle-kit push",
  "db:seed": "tsx server/seed.ts",
  "build": "vite build",
  "start": "node dist/server/index.cjs"
}
```

### First‚ÄëRun Steps (works without keys)

1. Create `/data` folder.
2. Run \`\` ‚Üí creates SQLite schema locally.
3. Run \`\` ‚Üí inserts **Practice Week** + sample DealRows.
4. Run \`\` ‚Üí open the preview URL.
5. Go to **Weeks ‚Üí Inbox ‚Üí Deals**. Click **Score All Deals**. Export files from **Exports**.

*(Optional)* Turn on AI: set `AI_ENABLED=true` and add one provider key.

---

## Appendix A ‚Äì **Ad Planner (Hernando 2025‚Äë06) Excel Mapping Spec**

**File validated:** `Hernando 6-25-25 Ad planner - Excel Final.xlsx`

**Observed:** 1 sheet (`Sheet1`), \~1,888 rows; \~1,710 item rows after filtering out totals/headers. Columns include: `ORDER #`, `FEATURE DESCRIPTION`, `SEQ`, `PAGE NAME`, `DEPT`, `PK`, `SZ`, `PQTY`, `ITEM DESC`, `UPC`, `COST`, `AMAP`, `EBA`, `ADBB`, `TPRBB`, `ADSCAN`, `TPRSCAN`, `ESCAN`, `ECOMP`, `ETPR`, `UCOST`, `SP/`, `AD SRP`, `SP/.1`, `REGSRP`, `MVMT`, `GP%`, `FEATURE NOTES`, `TPR DATES`.

### A1. Signature & Detection

- **Signature rule:** File qualifies as an **Ad Planner** if it contains all of: `ORDER #`, `ITEM DESC`, `DEPT`, `UCOST`, `AD SRP`. Bonus signals: `PAGE NAME`, `FEATURE DESCRIPTION`, `MVMT`, `GP%`.
- **Skip rows:** where `ORDER #` is blank **or** `ITEM DESC` is blank **or** `FEATURE DESCRIPTION` ends with `Total` or equals `Grand Total`.

### A2. Canonical Mapping ‚Üí `CanonicalRow`

- `itemCode` ‚üµ `ORDER #` (string)
- `description` ‚üµ `ITEM DESC`
- `dept` ‚üµ `DEPT` (normalize title‚Äëcase; allow many depts ‚Äî not limited to 4)
- `upc` ‚üµ `UPC` (cast to string; strip non‚Äëdigits; **don‚Äôt** drop leading zeros; accept 10/12/13/14 length)
- `cost` ‚üµ prefer `UCOST`; fallback `COST`/`PK` logic if `UCOST` is missing in other planners
- `srp` ‚üµ `REGSRP`
- `adSrp` ‚üµ `AD SRP`
- `mvmt` ‚üµ `MVMT`
- `marginPct` ‚üµ `GP%`
- `pack` ‚üµ `PK`
- `size` ‚üµ `SZ`
- `promoStart/promoEnd` ‚üµ parse from `TPR DATES` if present (e.g., `TPR Dates: 06/15/2025 Thru 07/12/2025`)
- `funding` fields (optional enrichers):
  - `amapPct` ‚üµ `AMAP`
  - `scanAllowances` ‚üµ { `ADSCAN`, `TPRSCAN`, `ESCAN` }
  - `billbacks` ‚üµ { `ADBB`, `TPRBB` }
  - `competitor` ‚üµ { `ECOMP`, `ETPR` }

### A3. Pricing Pattern Extraction

- If `SP/` ‚â• 2 and `AD SRP` > 0 ‚áí **multi‚Äëbuy** pattern (e.g., `2 for $4` if `SP/`=2, `AD SRP`=4).
- If `SP/` is 1 or blank ‚áí **unit** price = `AD SRP`.
- Optional per‚Äëunit field from `SP/.1` if present.

### A4. Quality Gates (V0.1)

- **Block scoring** if any holds:
  - `UCOST` or `AD SRP` missing on >5% of candidate rows (this file = **0% missing** among item rows).
  - Unresolved department/description on >1%.
- **Warnings** (do not block): missing `REGSRP`, missing funding columns, malformed `TPR DATES`.

### A5. Dept Mix Handling

- Allow dynamic departments from file (`Grocery`, `Dairy`, `Frozen`, etc.). Defaults for the 65‚Äëitem mix can be redistributed or edited per batch. Provide preset groups, but do **not** force remapping.

### A6. Acceptance Checklist (for this template)

1. Upload parses with **‚â•90%** rows auto‚Äëdetected as items (observed \~90.6%).
2. `ORDER #`, `ITEM DESC`, `DEPT`, `UCOST`, `AD SRP` map cleanly to canonical fields.
3. UPC renders as strings (no scientific notation) with leading zeros preserved.
4. Multi‚Äëbuy patterns appear for rows with `SP/` ‚â• 2.
5. Exports include `itemCode`, `description`, `dept`, `ad price`, `pricing pattern`, and `score`.

### A7. Notes & Edge Cases

- `UPC` values in this file are often **10‚Äëdigit**; treat as internal codes, not strictly 12‚Äëdigit UPC‚ÄëA. Keep flexible length and store as text.
- Totals rows appear interspersed; filtering by `ORDER #` presence is sufficient to ignore them.
- Some planners may use `COST` instead of `UCOST`; our mapper prefers `UCOST` but has fallbacks.

### A8. Test Data Hooks

- Add a unit test fixture with 10 representative rows (multi‚Äëbuy, unit price, missing fields, edge UPC) to lock parsing behavior.



---

## Appendix B ‚Äì Alliance Group Buy PDF Mapping (Virtual Pallet & Mods)

Templates reviewed:

- Alliance Group Buy ‚Äì Kingsford/Match Light Charcoal Briquets (5/18‚Äì7/12/25): tabular PDF with cost, freight, billbacks, UDC, scan allows, suggested retails, GP%, order minimum notes, and ship dates.
- Alliance Group Buy ‚Äì WK Kellogg‚Äôs Large Kid Cereal Half Mod (5/11‚Äì5/24/25): tabular PDF with kit or mod metrics plus a CONTAINS breakdown of SKUs, sizes and UPCs; includes ‚ÄúHot price 2/\$5 @ 3.3% GM‚Äù callout.

B1. Detection & Parsing

- Detection: look for the header ‚ÄúAlliance Group Buy‚Äù plus columns like PACK, SIZE, UPC, AWG #, CASE COST, AMAP, UDC w/frt, AD RETAIL, G.P.%, QTY.
- Parsing path:
  1. Try table extraction using the ruling lines in the PDF.
  2. If tables do not extract cleanly, use a text grid and column heuristics.
  3. If still ambiguous, show a manual column-mapper UI (drag to assign), and save a reusable template for this vendor.

B2. Field Map to CanonicalRow / Funding / Program

- pack ‚Üê PACK (example: 1 or 126 ASST for a mod)
- size ‚Üê SIZE
- mfg ‚Üê MFG
- upc ‚Üê UPC (store as text; preserve leading zeros)
- awgCode ‚Üê AWG #
- description ‚Üê PRODUCT DESCRIPTION
- caseCost ‚Üê CASE COST
- caseCostWithFreight ‚Üê CASE COST w/frt
- billback.groupBuy ‚Üê Virtual Group Buy Billback or Group Buy Billback
- billback.ad ‚Üê Ad BB
- scanAllow\.ad ‚Üê AD SCAN or Ad Scan
- scanAllow\.tpr ‚Üê TPR IPRO SCAN or TPR Scan IPRO
- udc.tprWithFreight ‚Üê TPR UDC w/frt or UDC TPR w/frt
- udc.adWithFreight ‚Üê AD UDC w/frt or UDC Ad w/frt
- tprRetail ‚Üê TPR Retail
- tprGpPct ‚Üê TPR G.P.%
- adRetail ‚Üê AD RETAIL
- adGpPct ‚Üê AD G.P.%
- qty ‚Üê QTY
- programShipDates and orderDeadline parsed from header or footer
- Derived: unitCost from best available UDC or case cost with freight; adSrp from AD RETAIL; fundingPct from billbacks and scan allowances; notes from the minimum-order lines.

B3. Mods and Kits (example: Kellogg‚Äôs Half Mod)

- Create a parent Kit row with aggregated economics and a KitComponents list from the CONTAINS section (UPC, size, count).
- Buyers can toggle ‚Äútreat as kit‚Äù versus ‚Äúexplode to items‚Äù before selection.

B4. Acceptance Criteria

1. At least 90% of rows auto-map on first import; any remaining rows can be fixed via the manual mapper, and the template is stored.
2. adSrp, unitCost, and funding are computed for each line; missing values show warnings but do not block scoring.
3. Kits can be represented as a single feature or as individual SKUs.
4. Source PDF is previewable; each parsed row links back to the page location.

---

## Appendix C ‚Äì ARG Sales Plan PPTX Parsing (Narrative + Deal Extraction)

C1. Detection & Goals

- Files like ARG\_SALES\_PLAN\_YYYY\_MM\_DD.pptx contain narrative copy with product names, price points (for example \$3.99 or 2/\$5), and margin notes.
- Goal: harvest featured items and price patterns plus display or shipper guidance; use them as Theme and Context signals and as optional candidate deals.

C2. Extraction Rules

- Parse all text boxes and tables for price patterns such as a dollar amount with two decimals or an X-for-Y format.
- Capture product name, price or pattern, category or department hint, and margin hint; assign a confidence score based on token proximity.
- Extract display directives like MANDATORY DISPLAY, pallet, shipper, endcap into DisplayHints linked to categories.

C3. Mapping & Influence

- Parsed items enter as candidates with lower default confidence and with Theme or Timing boosts.
- Display hints increase priority or add a Hero chip for layout suggestions.

C4. Acceptance Criteria

1. Detect at least 80% of explicit price patterns; show all detections in a review table where the buyer can approve or reject.
2. Approved items flow into scoring with theme and timing contributions.
3. Display hints render on the ad page as chips and do not block exports.

---

## Appendix D ‚Äì Source File Storage & Linking

D1. Storage Plan (Replit friendly)

- Save original files under /uploads/{batchId}/{uuid}-{safeFilename} and record metadata in Upload: id, batchId, kind, filename, mimetype, byteSize, hash, storagePath, pageCount (optional), vendor (optional), orderDeadline (optional).
- Optional later: push to S3 or Supabase Storage while keeping the same metadata contract.

D2. Access & Security

- Add an endpoint /api/uploads/\:id/original that streams the exact file with an inline disposition and a short-lived signed token.
- In the UI, every parsed row has an ‚ÄúOpen original‚Äù link; when possible store a sourceRef of uploadId, page number, and vertical offset.

D3. Audit & Traceability

- Exports include sourceFile and sourceRef so buyers can trace the origin.
- Keep a content hash; if a new upload matches a prior hash, offer to reuse the saved mapping template.



---

## Section: UI and UX Flow (AI/ML‚ÄëFirst)

- Keep **Weeks ‚Üí Inbox ‚Üí Deals ‚Üí Exports ‚Üí Calendar**.
- Add **AI toggles** that appear only when `AI_ENABLED=true`:
  - Inbox row: **AI Assist parsing** (PDF/PPT text‚Üírows) ‚Üí approve/reject grid.
  - Deals row: **Refine explanation** (reword reasons; score unchanged).
  - PPTX panel: **Extract candidates**.
- Stepper across week pages: **Ingest ‚Üí Map ‚Üí Validate ‚Üí Score ‚Üí Review ‚Üí Export** with readiness %.
- Quality‚Äëgate: block scoring if **>5%** candidates missing cost or ad price.

---

## Week‚ÄëCentric Mode (replaces ‚ÄúBatches‚Äù)

### Terminology

- **AdWeek**: one Wed‚ÜíTue advertising week (fields: `id`, `year`, `week`, `label`, `start`, `end`, `status`).
- **Weekly Inbox**: all incoming files for that AdWeek (email drops, portal downloads, manual uploads).
- ‚ÄúBatch‚Äù remains a **temporary alias** for migration but UI uses **Weeks** everywhere.

### Weekly Flow (buying‚Äëfirst)

1. **Pick Week** on Weeks page (or auto‚Äëadvance to the current week driven by your Week Schedule Excel).
2. **Weekly Inbox**: drag‚Äëdrop all vendor deal files. System detects: Base Ad Planner, Dept planners (Meat/Grocery/Produce/Bakery/etc.), Group Buy PDFs, Sales Plan PPTX, Rolling Stock.
3. **Canonicalize to DealRow** per file type with a SourceDoc link. Unknown formats use the Column‚ÄëMapper wizard (template saved by vendor).
4. **Score & Rank**: run one ‚ÄúScore All Deals‚Äù action ‚Üí creates a **Weekly Deal Bank** (the master ranked list for buyers). Weights & multipliers adjustable; chips explain ‚Äúwhy.‚Äù
5. **(Optional) Theme/Timing**: from Week schedule + PPTX hints; boosts but does not block.
6. **Exports**: Weekly Deal Bank CSV, Buyer TXT, Designer JSON. (Ad selection is not required to export ranked buys.)

### UI pages (week‚Äëfirst)

- **Weeks (home):** grid of weeks with status dots (Inbox, Parsing, Issues, Scored, Exported). New Week from schedule.
- **Inbox:** per‚Äëweek file list with detection status, parsed rows, ‚ÄúOpen original,‚Äù ‚ÄúMap columns,‚Äù ‚ÄúReprocess.‚Äù
- **Deals:** the master **Weekly Deal Bank** table (not dept boards). Columns: item, dept, ad price, margin, velocity, funding, score, chips, source link.
- **Weights:** right‚Äëside drawer to tune component weights per week and re‚Äëscore.
- **Exports:** history of generated artifacts with traceability back to SourceDocs.
- **Calendar:** week schedule editor (import from Excel; override dates; set theme keywords).

### Data Model (Prisma sketch)

```prisma
model AdWeek {
  id        String   @id @default(cuid())
  year      Int
  week      Int      // ISO week
  label     String   // e.g., "2025-W26"
  start     DateTime
  end       DateTime
  status    String   // Inbox | Parsing | Issues | Scored | Exported
  createdAt DateTime @default(now())
  sourceDocs  SourceDoc[]
  deals       DealRow[]
  scores      Score[]
  recs        Recommendation[]
}

model SourceDoc {
  id        String   @id @default(cuid())
  adWeekId  String
  kind      String   // base-planner | dept-planner | group-buy-pdf | sales-plan-pptx | rolling-stock | other
  vendor    String?
  filename  String
  mimetype  String
  byteSize  Int
  storagePath String
  hash      String
  pageCount Int?
  meta      Json?
  createdAt DateTime @default(now())
  adWeek    AdWeek   @relation(fields: [adWeekId], references: [id])
}

model DealRow { // formerly CanonicalRow
  id        String   @id @default(cuid())
  adWeekId  String
  sourceDocId String
  itemCode  String
  description String
  dept      String
  cost      Float?
  srp       Float?
  adSrp     Float?
  vendorFundingPct Float?
  mvmt      Float?
  competitorPrice Float?
  pack      String?
  size      String?
  promoStart DateTime?
  promoEnd   DateTime?
  sourceRef  Json?      // {page, yOffset}
  createdAt DateTime @default(now())
  adWeek    AdWeek   @relation(fields: [adWeekId], references: [id])
  sourceDoc SourceDoc @relation(fields: [sourceDocId], references: [id])
}
```

### Week Schedule Excel (import)

- Add **Appendix E** mapping for your schedule workbook: we accept columns like `Year`, `Week`, `Start`, `End`, optional `Ad Name`, `Theme`.
- Import ‚Üí pre‚Äëseed the year‚Äôs **AdWeek** rows and drive the default ‚Äúcurrent week.‚Äù

### Acceptance (week‚Äëfirst)

1. A fresh Repl with only a Week Schedule import lets you pick the current week and see an empty **Weekly Inbox**.
2. Upload mixed files; ‚â•90% parse into **DealRow** with **SourceDoc** links and ‚ÄúOpen original.‚Äù
3. Clicking **Score All Deals** produces a ranked **Weekly Deal Bank** without doing any ad layout.
4. Exports pull from the ranked bank and include traceability back to SourceDoc and page.

---

## Appendix E ‚Äì Week Schedule Excel Mapping

- **Detection**: presence of columns that include at least (`Year` or `Start`), (`Week` or `Label`), (`Start`), (`End`).
- **Fields**: `year`, `week` (ISO), `label` (if present), `start`, `end`, optional `themePrimary`, `themeSecondary`.
- **Acceptance**: importing creates or updates the year‚Äôs `AdWeek` rows; calendar highlights current week; Weeks page filters default to current week.

---

## Appendix F ‚Äì Email/Portal Ingestion (future‚Äëproofing)

- **Email**: create a unique intake address (e.g., deals\@yourdomain). A small worker stores attachments as `SourceDoc` under the current `AdWeek` using subject/date heuristics. For V0.1, manual upload replicates the same path.
- **Portal**: per‚Äëvendor scripts (or manual downloads) drop files into the **Inbox**; templates learned by vendor.
- **Traceability**: keep message id / portal URL in `SourceDoc.meta` for audit; all paths still produce `DealRow` and link to originals.



---

## V0.1 Acceptance Clarifiers (Novice‚ÄëReady & Audit‚ÄëReady)

- **Guided Stepper (required in V0.1):** Visible on all week pages: **Ingest ‚Üí Map ‚Üí Validate ‚Üí Score ‚Üí Review ‚Üí Export** with a readiness meter (0‚Äì100).
- **Beginner Aids:** Glossary tooltips on margin, movement, funding; a **Practice Week** seeded with 10‚Äì20 mixed rows so a first‚Äëtimer can demo end‚Äëto‚Äëend.
- **Security for originals:** `/api/uploads/:id/original` returns a signed URL with **TTL 5‚Äì15 minutes**, scoped to the current user/session; served with `Content‚ÄëDisposition: inline`.
- **Export audit trail:** Persist `exportId`, `adWeekId`, `createdAt`, `createdBy`, `artifactHash`, and a per‚Äërow back‚Äëlink to `SourceDoc` (file + page where applicable).
- **Explicit gates:** Block scoring when **>5%** of candidate rows are missing **cost or ad price**. Warn (don‚Äôt block) on missing competitor price or REGSRP.
- **Novice success metric:** A first‚Äëtime user completes **Ingest ‚Üí Export** in **‚â§10 minutes** without external guidance.
- **Testing:** Fixtures for CSV/XLSX; a Column‚ÄëMapper **template re‚Äëuse** test (same file hash auto‚Äëapplies saved mapping).

---

## Implementation Plan & Checklist (V0.1)

**Phase 0 ‚Äì Repo & Foundation**

-

**Phase 1 ‚Äì Week Schedule & Calendar**

-

**Phase 2 ‚Äì Weekly Inbox & Originals**

-

**Phase 3 ‚Äì Canonicalization & Column Mapper**

-

**Phase 4 ‚Äì Scoring Engine & Reasons**

-

**Phase 5 ‚Äì Deals Page & Weights**

-

**Phase 6 ‚Äì Exports & History**

-

**Phase 7 ‚Äì Beginner Mode & Stepper**

-

**Phase 8 ‚Äì PPTX & PDF (minimal)**

-

**Phase 9 ‚Äì Tests & Fixtures**

-

**Phase 10 ‚Äì Demo & Docs**

-



---

## Desktop Mode (Operator Console) ‚Äì How You Drive This Like an App

**Goal:** Treat Replit like a desktop app: one window, clear buttons, and keyboard shortcuts so you (or anyone) can run **Ingest ‚Üí Export** fast.

### Layout to ask Ghostwriter to scaffold

- **Left sidebar:** Weeks ‚Ä¢ Inbox ‚Ä¢ Deals ‚Ä¢ Exports ‚Ä¢ Calendar
- **Top bar:** Current Week selector + primary action button (changes by page: *Import Schedule*, *Upload Files*, *Score All Deals*, *Download Exports*)
- **Right drawer:** Plain‚Äëlanguage reasons, funding math, **Open original** link (deep‚Äëlink to PDF page when available)
- **Bottom status bar:** Readiness % and last action/result (e.g., ‚ÄúScored 1,742 items in 3.2s‚Äù)

### Keyboard shortcuts (beginner‚Äëfriendly)

- `G W` Go to **Weeks**
- `G I` Go to **Inbox**
- `G D` Go to **Deals**
- `G E` Go to **Exports**
- `G C` Go to **Calendar**
- `U` Upload files (opens file picker on Inbox)
- `S` **Score All Deals** (Deals page)
- `R` **Re‚Äëscore** (after weights tweak)
- `?` Show keyboard help overlay

### Guided Stepper (always visible)

**Ingest ‚Üí Map ‚Üí Validate ‚Üí Score ‚Üí Review ‚Üí Export** with a readiness bar (0‚Äì100). Steps light up green as you finish.

### ‚ÄúOpen Original‚Äù on every row

- Click the link or press `O` to open source; the endpoint streams via a 5‚Äì15 minute signed URL.

---

## Replit Agent ‚Äì Copy/Paste Prompts (Use in Ghostwriter)

### 1) Scaffold the desktop mode

```
Use the attached plan, and build ‚ÄúDesktop Mode (Operator Console)‚Äù for a week‚Äëfirst Next.js + Prisma app:
- Sidebar: Weeks, Inbox, Deals, Exports, Calendar
- Top bar: Current Week selector + context primary action
- Right drawer shared across pages (reasons + Open Original)
- Bottom status bar with readiness % + last action
- Keyboard shortcuts: GW, GI, GD, GE, GC, U, S, R, ?
- Guided Stepper (Ingest‚ÜíMap‚ÜíValidate‚ÜíScore‚ÜíReview‚ÜíExport) visible on all week pages
Ship pages: /weeks, /inbox, /deals, /exports, /calendar with minimal Tailwind UI.
```

### 2) Models & DB

```
Implement Prisma models AdWeek, SourceDoc, DealRow, Score exactly as in the plan.
Add seed script for ‚ÄúPractice Week‚Äù and ~10 sample rows.
Expose `/health` and `.env.example` with DATABASE_URL only.
Run `npx prisma db push` tasks in the dev script.
```

### 3) Uploads & Originals

```
Create POST /api/weeks/:id/uploads to accept files and save originals to /uploads/{adWeekId}/{uuid}-{safeFilename}; compute and store a content hash.
Create GET /api/uploads/:id/original to return a short‚Äëlived signed URL (TTL 10 min), inline only.
Wire Inbox UI: list SourceDocs, show parsed rows count, actions: Open Original, Map Columns, Reprocess.
```

### 4) Parsing & Column Mapper

```
CSV/XLSX: use xlsx + csv-parse; keep UPC as TEXT (10‚Äì14 digits, preserve leading zeros).
Unknown layouts open a Column Mapper wizard; store per‚Äëvendor templates keyed by vendor + header hash; auto‚Äëapply on matches.
```

### 5) Scoring & Reasons

```
POST /api/weeks/:id/score: components {margin, velocity, funding, theme, timing, competitive} weights {.25,.25,.20,.15,.10,.05}; multipliers {newItem, seasonal, strategic, historical, privateLabel}.
Persist plain‚Äëlanguage reasons[] (1‚Äì3 sentences) per DealRow.
Quality gate: block if >5% missing cost OR ad price; show banner with ‚ÄúFix now‚Äù links.
```

### 6) Deals & Exports

```
/deals: Ranked Weekly Deal Bank; chips; filters (dept, unresolved, high score, changed since last week). Right drawer shows reasons + Open Original.
/exports: GET weekly-deal-bank.csv, buyer-report.txt, designer.json. Each row includes sourceFile + sourceRef (file + page).
Record export history with user, timestamp, artifact hash.
```

### 7) Calendar & Schedule Import

```
/calendar: Import Week Schedule (CSV/XLSX) with Year, Week, Start, End, Theme. Seed AdWeek and set current week.
```

### 8) Testing & Beginner Mode

```
Fixtures for CSV/XLSX + a template re‚Äëuse test (same hash auto‚Äëmaps).
Practice Week seed and a toggle to load it; keyboard help overlay (`?`).
```

---

## What I cannot do for you automatically

I can‚Äôt click inside your Replit UI or run commands on your machine. But if you paste the prompts above to Ghostwriter, it will scaffold the exact desktop‚Äëmode app and I can keep refining with you step‚Äëby‚Äëstep.



---

## Runbook: If Replit won‚Äôt start

1. **Kill stale runs** (stop any agent tasks).
2. **Clear node\_modules** only if corrupted; then `npm install`.
3. Verify `DB_DIALECT=sqlite` and `DATABASE_URL=file:./data/app.db`.
4. `npm run db:push` ‚Üí `npm run db:seed` ‚Üí `npm run dev`.
5. If port busy, set `PORT=3000` (Replit auto-maps) and restart.
6. Check console for ESM/CJS issues; use `tsx` everywhere for TS runtime.

## Acceptance (AI/ML‚ÄëFirst V0.1)

- Boots on Replit **without** keys (SQLite, deterministic fallbacks).
- With keys: AI toggles appear; explain/extract endpoints work; ai\_calls logs tokens/cost.
- Exports have source refs; ExportHistory records actor/time/hash.
- Stepper + gate (>5% missing cost/ad price) enforced.
- Outcomes captured; ML flag compiles; ‚ÄúLearning boost‚Äù chip renders when on.

